apiVersion: batch/v1
kind: Job
metadata:
  name: controller
  labels:
    jobgroup: contr
spec:
  template:
    metadata:
      name: contr
      labels:
        jobgroup: contr
    spec:
      containers:
      - name: rtc
        image: jaredscience/ray_tracer_controller:latest
        volumeMounts:
        - mountPath: /data
          name: nfs-server
        command: ["python", "controller.py",
                  "--width={{ params[0].get('width') }}",
                  "--height={{ params[0].get('height') }}",
                  "--scene_location={{ params[0].get('scene_location') }}"]
      restartPolicy: Never
      volumes:
      - name: nfs-server
        nfs:
          # TODO: put url here
          server: 10.11.252.189
          path: /
---
{%- for p in params %}
{%- set part = p["part"] %}
{%- set width = p["width"] %}
{%- set height = p["height"] %}
{%- set location = p["scene_location"] %}
apiVersion: batch/v1
kind: Job
metadata:
  name: worker-{{ part }}
  labels:
    jobgroup: worker
spec:
  template:
    metadata:
      name: worker
      labels:
        jobgroup: worker
    spec:
      containers:
      - name: rtw
        image: jaredscience/ray_tracer_worker:latest
        volumeMounts:
        - mountPath: /data
          name: nfs-server
        command: ["python", "worker.py", "{{ part }}", "--width={{ width }}",
                  "--height={{ height }}", "--scene_location={{ location }}"]
      restartPolicy: Never
      volumes:
      - name: nfs-server
        nfs:
          # TODO: put url here
          server: 10.11.252.189
          path: /
---
{%- endfor %}
